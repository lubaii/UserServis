# Руководство по тестированию

Проект содержит два типа тестов:
- **Интеграционные тесты** для DAO-слоя с использованием локальной базы данных PostgreSQL
- **Юнит-тесты** для Service-слоя с использованием Mockito

## Зависимости для тестирования

- **JUnit 5** (junit-jupiter) - фреймворк для тестирования
- **Mockito** - библиотека для создания моков
- **Testcontainers** - опциональная библиотека (не используется в текущей версии)

## Структура тестов

```
src/test/
├── java/
│   └── com/
│       └── userservice/
│           ├── dao/
│           │   └── UserDAOIntegrationTestLocalDB.java    # Интеграционные тесты DAO (локальная БД)
│           ├── service/
│           │   └── UserServiceTest.java          # Юнит-тесты Service
│           └── util/
│               └── TestHibernateUtil.java        # Утилита для тестов
└── resources/
    └── hibernate-test.cfg.xml                    # Тестовая конфигурация Hibernate
```

## Запуск тестов

### Запуск всех тестов
```bash
mvn test
```

### Запуск только юнит-тестов (без Testcontainers)
```bash
mvn test -Dtest=UserServiceTest
```

### Запуск только интеграционных тестов
```bash
mvn test -Dtest=UserDAOIntegrationTestLocalDB
```

### Запуск конкретного теста
```bash
mvn test -Dtest=UserServiceTest#testCreateUserSuccess
```

## Интеграционные тесты (UserDAOIntegrationTestLocalDB)

### Особенности:
- Используют **локальный PostgreSQL** (без Docker/Testcontainers)
- Подключаются к той же базе данных, что и основное приложение (`usersdb`)
- Каждый тест изолирован - база данных очищается перед каждым тестом
- Тесты выполняются в определенном порядке с помощью `@Order`
- Проверяют реальное взаимодействие с базой данных

### Что тестируется:
- ✅ Создание пользователя
- ✅ Чтение пользователя по ID
- ✅ Чтение всех пользователей
- ✅ Обновление пользователя
- ✅ Удаление пользователя
- ✅ Обработка ошибок (пользователь не найден, дубликат email)
- ✅ Изоляция данных между тестами

### Требования:
- PostgreSQL должен быть установлен и запущен локально
- База данных `usersdb` должна существовать
- Учетные данные должны совпадать с настройками в `hibernate.cfg.xml`
- Тесты используют реальную БД, но очищают данные перед каждым тестом

## Юнит-тесты (UserServiceTest)

### Особенности:
- Используют **Mockito** для мокирования UserDAO
- Тестируют бизнес-логику без доступа к базе данных
- Быстрые и изолированные тесты
- Проверяют валидацию данных

### Что тестируется:
- ✅ Создание пользователя с валидными данными
- ✅ Валидация имени (пустое, null, слишком длинное)
- ✅ Валидация email (неверный формат, null, слишком длинный)
- ✅ Валидация возраста (отрицательный, больше 150, null)
- ✅ Получение пользователя по ID
- ✅ Получение всех пользователей
- ✅ Обновление пользователя (полное и частичное)
- ✅ Удаление пользователя
- ✅ Обработка ошибок (пользователь не найден, неверный ID)

## Изоляция тестов

### Интеграционные тесты:
- База данных очищается перед каждым тестом в методе `@BeforeEach clearDatabase()`
- Каждый тест использует отдельную транзакцию
- Используется локальная БД PostgreSQL (та же, что и в основном приложении)

### Юнит-тесты:
- Каждый тест создает новый экземпляр UserService с моком UserDAO
- Моки изолированы друг от друга
- Используется `@BeforeEach` для настройки тестовых данных

## Примеры использования

### Пример интеграционного теста:
```java
@Test
@DisplayName("Should create user successfully")
void testCreateUser() {
    User user = new User("John Doe", "john@example.com", 30);
    Long id = userDAO.create(user);
    assertNotNull(id);
}
```

**Примечание:** Тесты используют локальную БД, поэтому убедитесь, что PostgreSQL запущен и база данных `usersdb` существует.

### Пример юнит-теста:
```java
@Test
@DisplayName("Should create user successfully with valid data")
void testCreateUserSuccess() {
    when(userDAO.create(any(User.class))).thenReturn(1L);
    User created = userService.createUser("John Doe", "john@example.com", 30);
    assertNotNull(created);
    verify(userDAO, times(1)).create(any(User.class));
}
```

## Покрытие тестами

- **UserDAO**: Полное покрытие всех CRUD-операций и обработки ошибок
- **UserService**: Полное покрытие бизнес-логики и валидации

## Примечания

- Интеграционные тесты используют локальную БД PostgreSQL (без Docker)
- Для быстрой разработки рекомендуется запускать сначала юнит-тесты
- Интеграционные тесты лучше запускать перед коммитом или в CI/CD
- Убедитесь, что PostgreSQL запущен перед запуском интеграционных тестов

